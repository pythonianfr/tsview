<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet"
              href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
              integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
              crossorigin="anonymous">
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
        <script src="https://cdn.plot.ly/plotly-1.50.1.min.js"></script>
        <link rel="stylesheet" href="{{ url_for('tsview.static', filename='pygmentize.css') }}"/>
        <link rel="stylesheet" href="{{ url_for('tsview.static', filename='style.css') }}"/>
        <link href="{{ url_for('tsview.static', filename='menu_elm.css')}}" rel="stylesheet"/>
        <script src="https://unpkg.com/@webcomponents/custom-elements@1.2.1/custom-elements.min.js">
        </script>
        <script src="./tsview_static/tsinfo_elm.js"></script>
        <script>
            class PlotFigure extends HTMLElement {
                static get observedAttributes() {
                    return ['args', 'history-args', 'hover-args'];
                }
                    attributeChangedCallback(name, old_value, new_value) {
                        if ( name == 'args' ) {
                            function doit () {
                                let args = JSON.parse(new_value);
                                Plotly.newPlot(
                                    args.div,
                                    args.data,
                                    args.layout,
                                    {
                                        displaylogo: false,
                                        displayModeBar: true,
                                        displaylogo: false,
                                        responsive: true,
                                        modeBarButtonsToRemove: ['sendDataToCloud']
                                    }
                                );
                                document.getElementById(args.div).on(
                                    'plotly_relayout', function(eventData) {
                                        var range;
                                        if (eventData['xaxis.range[0]'] !== undefined
                                            && eventData['xaxis.range[1]'] !== undefined) {
                                            range = [
                                                eventData['xaxis.range[0]'],
                                                eventData['xaxis.range[1]']
                                            ];
                                        } else {
                                            range = ["", ""];
                                        }
                                        app.ports.dateInInterval.send(range);
                                    }
                                );
                            }
                            setTimeout(doit, 10)
                        }
                        if ( name == 'history-args' ) {
                            function doit () {
                                let history_args = JSON.parse(new_value);
                                Plotly.newPlot(
                                    history_args.div,
                                    history_args.data,
                                    history_args.layout,
                                    {
                                        displaylogo: false,
                                        displayModeBar: true,
                                        displaylogo: false,
                                        responsive: true,
                                        modeBarButtonsToRemove: ['sendDataToCloud']
                                    }
                                );
                                document.getElementById(history_args.div).on('plotly_hover', function(data){
                                    var points = data.points;
                                    var dates = [];
                                    var values = [];
                                    points.forEach(function(point){
                                        dates.push(point.data.name);
                                        values.push(point.y);
                                    });
                                    var data = {
                                            "name" : new Date(points[0].x),
                                            "dates" : dates,
                                            "values": values
                                        };

                                    app.ports.dataFromHover.send(JSON.stringify(data));
                                });
                            }
                            setTimeout(doit, 10)
                        }
                        if ( name == 'hover-args' ) {
                            function doit () {
                                let hover_args = JSON.parse(new_value);
                                Plotly.newPlot(
                                    hover_args.div,
                                    hover_args.data,
                                    hover_args.layout,
                                    {
                                        displaylogo: false,
                                        displayModeBar: true,
                                        displaylogo: false,
                                        responsive: true,
                                        modeBarButtonsToRemove: ['sendDataToCloud']
                                    }
                                );
                            }
                            setTimeout(doit, 10)
                        }
                    }
            }
            window.customElements.define("plot-figure", PlotFigure);
        </script>
    </head>
    <body>
        <div id="app"></div>
        <script>
         var app = Elm.Tsinfo.init({
             node: document.getElementById('app'),
             flags: {
                 baseurl : "{{ homeurl }}",
                 name : "{{ name }}"
             }
         });

         // port to copy something to the clipboard
         var clipboard = function (value) {
             var el = document.createElement('textarea');
             el.value = value;
             document.body.appendChild(el);
             el.select();
             document.execCommand('copy');
             document.body.removeChild(el);
         };
         app.ports.copyToClipboard.subscribe(clipboard);

         // this should probably be shared as a separate jinja template
         app.ports.saveToLocalStorage.subscribe(function (dataInCache) {
             localStorage.setItem("horizon", JSON.stringify(dataInCache))
         });

         incache = localStorage.getItem("horizon")
         if (incache === null) {
             incache = '{"horizon": null, "inferredFreq": false, "timeZone": "UTC"}'
         }
         app.ports.loadFromLocalStorage.send(incache);
        </script>
        {% include "menu.html" %}
    </body>
</html>
